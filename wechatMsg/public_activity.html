<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="never">
    <title>筋斗云管理系统</title>
    <link href="../css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
</head>
<body>
<div style="width: 90%;margin: 0 auto;padding: 10px 0;">
    <div style="margin-top: 30px;display: flex;">
        <div style="flex: 1;">
            <div>消息类型
                <label class="radio-inline">
                    <input type="radio" checked>图文消息
                </label>
            </div>
            <div class="row" style="width:100%;border: 1px solid black;padding: 6px;display: flex;flex-wrap: wrap;" id="news_wrap">
                <!--<div style="width: 300px;margin: 6px;">
                    <div style="display: flex;justify-content: space-between">
                        <span>新版雪佛兰</span>
                        <span style="background: black;color: white;padding: 0 3px;">48小时外</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <img src="https://mmbiz.qlogo.cn/mmbiz_jpg/dtx5cc74uKufOsic6p2PnQhryG1dB5uBwgic6AYG6eFtiaUNltibz48vw47PGN6gicYO6fPAOdibpjh5rV65EROHFbvg/640?wx_fmt=jpeg"
                             rel="noreferrer"
                             alt=""
                             style="width: 100%;overflow: hidden;">
                    </div>
                    <div style="display: flex;align-items:center;margin-top: 3px;">
                        <div style="width: 50px;">
                            <img src="https://mmbiz.qlogo.cn/mmbiz_jpg/dtx5cc74uKsIWkcXpOpbWTZUqVc1lQSMhbKzKONUx7CVvM58xUibILHtxc6BNJvHJZZ0ib0tkCYiaNa6gWoyFSiaTg/640?wx_fmt=jpeg"
                                 alt=""
                                 style="width: 100%;overflow:hidden;">
                        </div>
                        <div style="padding:0 3px;">标题</div>
                    </div>
                    <div style="display: flex;align-items:center;margin-top: 3px;">
                        <div style="width: 50px;">
                            <img src="https://mmbiz.qlogo.cn/mmbiz_jpg/dtx5cc74uKsIWkcXpOpbWTZUqVc1lQSMhbKzKONUx7CVvM58xUibILHtxc6BNJvHJZZ0ib0tkCYiaNa6gWoyFSiaTg/640?wx_fmt=jpeg"
                                 alt=""
                                 style="width: 100%;overflow:hidden;">
                        </div>
                        <div style="padding:0 3px;">标题</div>
                    </div>
                </div>-->
            </div>

        </div>
        <div style="background: rgb(245,247,250);padding:10px;width: 400px;">
            <form class="form-horizontal m-t" id="addWechatMaterialLogForm">
                <div class="form-group">
                    <label class="col-sm-4 control-label">发送时间 :</label>
                    <div class="col-sm-8">
                        <input type="text" name="start_time" class="form-control datef">
                        <!--<div style="margin-top: 3px;">
                            <span style="color: #0bb20c;">提示：自动创建成功</span>
                            <span style="color: #ee1e2d;display: none;">提示：自动创建失败，请手动创建</span>
                        </div>-->
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">间隔日期  :</label>
                    <div class="col-sm-8">
                        <input type="number" name="next_day" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">粉丝性别:</label>
                    <div class="col-sm-8">
                        <label class="radio-inline">
                            <input type="radio" name="sex" value="0">未知
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="sex" value="1">男
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="sex" value="2">女
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="sex" value="3" checked>全部
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">支付状态  :</label>
                    <div class="col-sm-8">
                        <label class="radio-inline">
                            <input type="radio" name="is_pay" value="0">未支付
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="is_pay" value="1">已支付
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="is_pay" value="2" checked>全部
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-4 control-label">互动时间  :</label>
                    <div class="col-sm-8">
                        <label class="radio-inline">
                            <input type="radio" name="is_active" value="0">48小时内
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="is_active" value="1">48小时外
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="is_active" value="2" checked>全部
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-12" style="text-align: right;">
                        <button class="btn btn-sm btn-default">取消</button>
                        <button class="btn btn-sm btn-default"
                                type="button"
                                onclick="addWechatMaterialLog()"
                                style="background: rgb(64,158,255);color: white;border-color:rgb(64,158,255);">保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <div class="panel panel-default">
            <div class="panel-heading" style="text-align: center;background: rgb(245,247,250);">发送日志</div>
            <div class="panel-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>新建时间（赠币活动创建时间）</th>
                            <th>发送时间</th>
                            <th>链接状态</th>
                            <th>性别</th>
                            <th>是否支付</th>
                            <th>互动时间</th>
                            <th>发送结果</th>
                            <th>运行状态</th>
                            <th>发送成功</th>
                            <th>发送失败</th>
                            <th>发送人数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div  id="error_log" style="display: none">
    <table class="table">
        <thead>
        <tr>
            <th>公众号</th>
            <th>错误信息</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="error_tbody">
        </tbody>
    </table>
</div>

<script src="../js/jquery.min.js?v=2.1.4"></script>
<script src="../js/public.js"></script>
<script src="../js/bootstrap.min.js?v=3.3.6"></script>
<script src="../js/layer/layer.js"></script>
<script src="../js/laydate/laydate.js"></script>
<script>
    //全选
    $(document).on('click','.role-all',function () {
        $(this).parents('label').next('div').find('input').prop('checked','checked');
    });
    //反选
    $(document).on('click','.role-invert',function () {
        $(this).parents('label').next('div').find('input').each(function () {
            if($(this).prop("checked"))
            {
                $(this).prop("checked",false);
            }else{
                $(this).prop("checked",true);
            }
        });
    });
    //取消
    $(document).on('click','.role-cancel',function () {
        $(this).parents('label').next('div').find('input').prop('checked',false);
    });
</script>

<script>
    $(function () {
        getMsgList();
        getLogList();
    });

    //时间选择
    laydate.render({
        elem: '.datef'
        ,type: 'datetime'
    });


    function getMsgList() {
        ajaxGo("admin/wechat_material/getListToMsg");
        console.log(requestData)
        var list=requestData.data;
        var htmlList=[];
        list.forEach(function (e) {
            var content=JSON.parse(e.content);
            var news_item=content['news_item'];
            var ahtml='<div style="width: 300px;margin: 6px;">\n' +
                '                <div style="display: flex;justify-content: space-between">\n' +
                '                    <span>'+news_item[0]['title']+'</span>\n' +
                '                    <span style="background: black;color: white;padding: 0 3px;">'+(e.type_name!=null?e.type_name:'未知')+'</span>\n' +
                '                </div>\n' +
                '                <div style="margin-top: 8px;">\n' +
                '                    <img src="'+news_item[0]['thumb_url']+'"\n' +
                '                         rel="noreferrer"\n' +
                '                         alt=""\n' +
                '                         style="width: 100%;overflow: hidden;">\n' +
                '                </div>\n' +'{{childrenNode}}'+
                '<div style="margin-top: 10px;"><label class="radio-inline"><input type="radio" name="material_type_id" value="'+e.type_id+'">选择</label></div>'+
                '            </div>';
            var bhtml=[];
            for (var i=1;i<news_item.length;i++){
                bhtml.push('<div style="display: flex;align-items:center;margin-top: 3px;">\n' +
                    '                    <div style="width: 50px;">\n' +
                    '                        <img src="'+news_item[i]['thumb_url']+'"\n' +
                    '                             alt=""\n' +
                    '                             style="width: 100%;overflow:hidden;">\n' +
                    '                    </div>\n' +
                    '                    <div style="padding:0 3px;">'+news_item[i]['title']+'</div>\n' +
                    '                </div>');
            }
            ahtml=ahtml.replace("{{childrenNode}}",bhtml.join(""));

            htmlList.push(ahtml);

        });
        //$('#addWechatMaterialLogForm input[name=material_type_id]').val(list[0]['type_id']);
        $('#news_wrap').empty();
        $('#news_wrap').append(htmlList.join(""));
    }

    //创建群发
    function addWechatMaterialLog() {
        layer.msg('确定保存？', {
            time: 0 //不自动关闭
            , btn: ['确定', '取消']
            , yes: function (index) {
                var material_type_id = $('input[name=material_type_id]:checked').val();
                if (!material_type_id || !material_type_id == null) {
                    layer.msg('请选择素材发送', {icon: 2});
                    return;
                }
                requestData.data = {
                    start_time: $('#addWechatMaterialLogForm input[name=start_time]').val(),
                    next_day: $('#addWechatMaterialLogForm input[name=next_day]').val(),
                    sex: $('#addWechatMaterialLogForm input[name=sex]:checked').val(),
                    is_pay: $('#addWechatMaterialLogForm input[name=is_pay]:checked').val(),
                    is_active: $('#addWechatMaterialLogForm input[name=is_active]:checked').val(),
                    material_type_id: material_type_id,
                };
                ajaxGo("admin/wechat_material_log/addWechatMaterialLog", '创建失败', false, 'http://tongji.zhanjuzhe.cn/');
                if (requestCode === 0) {
                    layer.close(index);
                    layer.closeAll();
                    layer.msg(requestMessage);
                } else {
                    layer.msg(requestMessage);
                }
                getLogList();
            }});
    }
    //记录列表
    function getLogList() {
        ajaxGo("admin/wechat_material_log/getList");
        console.log(requestData)
        var list=requestData.data.rows;
        $('#tbody').empty();
        if(list.length < 1){
            return;
        }
        list.forEach(function (e) {
            var statusStr="-";
            if (0 !== e.type) {
                statusStr = '结束';
            } else {
                switch (e.status) {
                    case 0:
                        statusStr = '<span style="color: green;">开启</span>';
                        break;
                    case 1:
                        statusStr = '<span style="color: red;">暂停</span>';
                        break;
                }
            }
            var actions=[];
            if(0 === e.type) {
                if (e.status == 0) {
                    actions.push('<a href="javascript:void(0);" onclick="suspendstart(' + e.id + ',1)">暂停</a>&nbsp;');
                } else {
                    actions.push('<a href="javascript:void(0);" onclick="suspendstart(' + e.id + ',0)">开启</a>&nbsp;');
                }
            }
            actions.push('<a href="javascript:void(0);" onclick="testSend('+e.material_type_id+')">测试发送</a>&nbsp;');

            var sexStr;
            switch (e.sex) {
                case 0:
                    sexStr="未知";
                    break;
                case 1:
                    sexStr="男";
                    break;
                case 2:
                    sexStr="女";
                    break;
                case 3:
                    sexStr="全部";
                    break;
            }
            var payStr;
            switch (e.is_pay) {
                case 0:
                    payStr="未支付";
                    break;
                case 1:
                    payStr="支付";
                    break;
                case 2:
                    payStr="全部";
                    break;
            }
            var typeStr;
            let log_msg = '正常';
            switch (e.type) {
                case 0:
                    log_msg = e.log_msg;
                    typeStr="未发送";
                    break;
                case 1:
                    log_msg = e.log_msg;
                    typeStr="发送中";
                    break;
                case 2:
                    typeStr="发送完成";
                    break;
            }
            let as  = '';
            switch (e.is_active) {
                case 0:
                    as="48小时内";
                    break;
                case 1:
                    as="48小时外";
                    break;
                case 2:
                    as="全部";
                    break;
            }
            let error = 0;
            if(e.error > 0){
                error = '<a href="javascript:void(0);" onclick="lookError(' + e.id + ',0)">'+e.error+'</a>&nbsp;';
            }

            $('#tbody').append('<tr>' +
                    '<td>'+e.create_at+'</td>'+
                '<td>'+e.time+'</td>'+
                '<td>'+e.log_msg+'</td>'+
                    '<td>'+sexStr+'</td>'+
                '<td>'+payStr+'</td>'+
                '<td>'+as+'</td>'+
                    '<td>'+typeStr+'</td>'+
                    '<td>'+statusStr+'</td>'+
                    '<td>'+e.success+'</td>'+
                '<td>'+error+'</td>'+
                '<td>'+e.people_num+'</td>'+
                    '<td>'+actions.join("")+'</td>'+
                '</tr>');
        });

    }

    //暂停启动
    function suspendstart(id,status) {
        var msg="";
        switch (status) {
            case 1:
                msg="确定暂停？";
                break;
            case 0:
                msg="确定开启？";
                break;
        }

        layer.msg(msg, {
            time: 0 //不自动关闭
            , btn: ['确定', '取消']
            , yes: function (index) {
                requestData.data = {
                    id: id,
                    status: status
                };
                ajaxGo("admin/wechat_material_log/delWechatMaterialLog", '暂停失败', false, 'http://tongji.zhanjuzhe.cn/');
                if (requestCode === 0) {
                    layer.close(index);
                    layer.closeAll();
                    layer.msg(requestMessage);
                } else {
                    layer.msg(requestMessage);
                }
                getLogList();
            }
        });
    }
    
    //测试发送
    function testSend(material_type_id) {
        layer.prompt({title: '请输入OPENID', formType: 2}, function(text, index){
            layer.close(index);
            var openid=text;

            if (openid==undefined||openid==""){
                layer.msg("请填写OPENID",{icon:2});
                return;
            }
            requestData.data={
                open_id:openid,
                material_type_id:material_type_id
            };
            ajaxGo("admin/wechat_material_log/testSend");
            if(requestCode === 0){
                getLogList();
                layer.close(index);
                layer.closeAll();
                layer.msg(requestMessage);
            }else {
                layer.msg(requestMessage);
            }
        });

    }

    //错误日志
    function lookError(id) {
        errorLists(id);
        layer.open({
            type: 1,
            title: '错误日志',
            shadeClose: true,
            shade: 0.8,
            area: ['60%', '60%'],
            content: $('#error_log'),
            btn: ['取消'], // 按钮
//            content: '{:U("User/editUser",array("id"=>'+id+',"act"=>display))}' //iframe的url
        });
    }

    function errorLists(id) {
        requestData.data={
            send_id : id
        };
        ajaxGo("admin/wechat_material_log/lookErrorList");
        var list=requestData.data.rows;
        $('#error_tbody').empty();
        if(list.length < 1){
            return;
        }
        list.forEach(function (e) {

            var actions=[];

            actions.push('<a href="javascript:void(0);" onclick="againSend('+e.id+','+id+')">重新发送</a>&nbsp;');

            $('#error_tbody').append('<tr>' +
                '<td>'+e.wechat_name+'</td>'+
                '<td>'+e.code+'</td>'+
                '<td>'+actions.join("")+'</td>'+
                '</tr>');
        });
    }

    /**
     * 重新发送错误日志
     * @param id
     */
    function againSend(id,m_id) {
        layer.msg('确定重新发送？', {
            time: 0 //不自动关闭
            , btn: ['确定', '取消']
            , yes: function (index) {
                requestData.data = {
                    'id': id,
                };
                ajaxGo('admin/wechat_material_log/againSend')
                errorLists(m_id);
                layer.msg(requestMessage);
            }
        });
    }
</script>



</body>
</html>